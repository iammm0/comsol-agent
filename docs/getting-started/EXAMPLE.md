# COMSOL Agent 示例与 TUI 用法

本文档说明如何在 TUI 中测试各模块的建模能力。运行前请确保已配置 `.env`（如 `COMSOL_JAR_PATH`、LLM 后端等）；启动 TUI 后输入 `/doctor` 可做环境检查。

- **启动方式**：`uv run comsol-agent` 或 `uv run python main.py`
- **已安装分发包**：直接执行 `comsol-agent`
- **模型输出目录**：所有 `.mph` 模型保存到 **comsol-agent 根目录下的 `models/`**（可在 TUI 中用 `/output 文件名.mph` 设置默认输出文件名）

---

## 1. 环境与诊断

```bash
uv run comsol-agent
```

在 TUI 中：

- 输入 **`/doctor`**：环境诊断（COMSOL、Java、LLM 等）
- 输入 **`/demo`**：查看解析能力演示（仅解析，不生成模型）

---

## 2. 几何建模（单形状）

在 TUI **默认模式**下，在底部输入框输入自然语言，回车即可生成模型。模型会保存到 `models/`（或通过 `/output` 设置的默认文件名）。

### 2.1 矩形

在 TUI 中输入例如：

- `创建一个宽1米、高0.5米的矩形`
- `创建一个宽2米、高1米的矩形，放在原点`

### 2.2 圆形

- `在原点放置一个半径为0.3米的圆`
- `创建一个半径为0.5米的圆，中心在(0, 0)`

### 2.3 椭圆

- `创建一个长轴1米、短轴0.6米的椭圆，中心在(0.5, 0.5)`
- `在(0.2, 0.2)处画一个长轴0.8米、短轴0.4米的椭圆`

---

## 3. 几何建模（多形状与组合）

在 TUI 中输入例如：

- `创建一个矩形宽1高0.5，再在(0.5, 0.25)处加一个半径0.1的圆`
- `创建两个矩形：一个1x0.5在原点，一个0.5x0.3在(1, 0)`

### 3.1 复杂几何（测试用提示词）

- `创建三个矩形：第一个宽2高1在(0,0)，第二个宽1高0.5在(2,0)，第三个宽0.8高0.4在(3,0.5)；再在(1,0.5)处加一个半径0.2的圆，在(2.5,0.25)处加一个长轴0.3短轴0.15的椭圆`
- `在原点画一个宽1.5米高0.8米的矩形，在(0.3,0.2)处挖一个半径0.1的圆表示孔，在(1,0.4)处再放一个半径0.05的圆`
- `创建 L 形几何：一个宽1高0.3的矩形在(0,0)，另一个宽0.4高0.5的矩形在(0,0.3)，两者相连`
- `创建阶梯状：底部矩形2x0.5在(0,0)，中间矩形1.2x0.4在(0.4,0.5)，顶部矩形0.6x0.3在(0.7,0.9)`

---

## 4. 仅规划不执行（plan）

在 TUI 中输入 **`/plan`** 切换到计划模式，下一句输入只会被解析为 JSON，不调用 COMSOL。可用于检查解析结果。

例如切换后输入：

- `创建一个宽1米、高0.5米的矩形`
- `在原点放一个半径0.3米的圆`
- `创建一个长轴1米短轴0.6米的椭圆，中心在(0.5, 0.5)`

输入 **`/run`** 可切回默认（run）模式。

---

## 5. 从 JSON 计划执行（exec）

在 TUI 中输入 **`/exec`**，按提示选择已有 JSON 计划文件，可据此创建模型或仅生成 Java 代码（若选择“仅代码”）。

---

## 6. ReAct 架构（完整流程）

默认模式即为 ReAct：会按需规划几何 → 物理场 → 网格 → 研究 → 求解。在 TUI 中直接输入完整需求即可，例如：

- `创建一个传热模型，包含一个矩形域，设置温度边界条件，进行稳态求解`
- `创建几何：宽1米高0.5米的矩形；并配置物理场与求解`
- `创建带矩形域的传热模型并求解`

---

## 7. TUI 斜杠命令速查

| 命令 | 说明 |
|------|------|
| `/run` | 默认模式：自然语言 → 生成模型 |
| `/plan` | 计划模式：自然语言 → 仅解析为 JSON |
| `/exec` | 根据 JSON 计划创建模型或生成代码 |
| `/demo` | 演示解析能力 |
| `/doctor` | 环境诊断 |
| `/context` | 上下文摘要、历史、统计、清除 |
| `/backend` | 选择 LLM 后端 |
| `/output` | 设置默认输出文件名 |
| `/help` | 帮助 |
| `/quit`、`/exit` | 退出 TUI |

---

## 8. 最小脚本（无 LLM，仅几何）

不依赖 LLM，直接用内置几何计划调用 COMSOL Java API 生成 `.mph`，用于验证 COMSOL 环境：

```bash
uv run python scripts/py_to_mph_minimal.py
```

会在 **comsol-agent 根目录下的 `models/`** 中生成 `minimal_model.mph`（一个 1m×0.5m 矩形）。确保 `.env` 中已配置 `COMSOL_JAR_PATH`。

---

## 9. 按能力对照

| 能力 | 在 TUI 中的操作 |
|------|------------------|
| **几何 - 矩形/圆/椭圆** | 默认模式输入对应自然语言描述 |
| **几何 - 多形状/复杂** | 默认模式输入组合描述（见上文 2、3 节） |
| **仅解析** | `/plan` 后输入描述 |
| **从 JSON 执行** | `/exec` 选择计划文件 |
| **ReAct 全流程** | 默认模式输入“创建传热模型…”等完整需求 |
| **环境诊断** | `/doctor` |
| **演示解析** | `/demo` |
| **无 LLM 几何** | 终端运行 `uv run python scripts/py_to_mph_minimal.py` |
