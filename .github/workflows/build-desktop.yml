# Tauri 桌面端：多平台构建并发布到 GitHub Release
# 触发：推送到 release 分支、推送 tag desktop-v*、或手动触发
name: Build and Release Desktop

on:
  workflow_dispatch:
  push:
    branches:
      - release
    tags:
      - 'desktop-v*'

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            args: ''
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: desktop/package-lock.json

      # 统一解析版本与发布 tag：tag 触发用 tag 版本，否则用 tauri 配置中的版本（用 bash + node 避免 Windows PowerShell 解析 JS）
      - name: Resolve version and release tag
        id: version
        shell: bash
        run: |
          node -e "
          const ref = process.env.GITHUB_REF || '';
          const refName = process.env.GITHUB_REF_NAME || '';
          const fs = require('fs');
          const path = require('path');
          let version, releaseTag;
          if (ref.startsWith('refs/tags/') && refName.startsWith('desktop-v')) {
            version = refName.replace(/^desktop-v/, '');
            releaseTag = refName;
          } else {
            const confPath = path.join('desktop', 'src-tauri', 'tauri.conf.json');
            const conf = JSON.parse(fs.readFileSync(confPath, 'utf8'));
            version = conf.version;
            releaseTag = 'desktop-v' + version;
          }
          const out = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(out, 'version=' + version + '\nrelease_tag=' + releaseTag + '\n');
          "
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}

      # 从 tag 触发时，将版本写回项目配置，保证构建产物版本与 release 一致（用 bash + node）
      - name: Sync version to project (when triggered by tag)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const v = process.env.VERSION;
          const confPath = path.join('desktop', 'src-tauri', 'tauri.conf.json');
          const conf = JSON.parse(fs.readFileSync(confPath, 'utf8'));
          conf.version = v;
          fs.writeFileSync(confPath, JSON.stringify(conf, null, 2));
          const cargoPath = path.join('desktop', 'src-tauri', 'Cargo.toml');
          let cargo = fs.readFileSync(cargoPath, 'utf8');
          cargo = cargo.replace(/^version = \".*\"/m, 'version = \"' + v + '\"');
          fs.writeFileSync(cargoPath, cargo);
          const pkgPath = path.join('desktop', 'package.json');
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
          pkg.version = v;
          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
          "
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: desktop/src-tauri

      - name: Install frontend dependencies
        run: npm ci
        working-directory: desktop

      - name: Download bundled JDK 11 (Windows)
        run: .\scripts\download-jdk11.ps1
        working-directory: desktop

      - name: Build and release (Tauri)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          tagName: ${{ steps.version.outputs.release_tag }}
          releaseName: COMSOL Agent Desktop v${{ steps.version.outputs.version }}
          releaseBody: 'See the assets below to download and install.'
          releaseDraft: true
          prerelease: false
          appVersion: ${{ steps.version.outputs.version }}
          args: ${{ matrix.args }}
